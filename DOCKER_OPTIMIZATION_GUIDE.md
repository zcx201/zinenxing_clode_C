# ============================================================================
# Dockeræ„å»ºä¼˜åŒ–è¯´æ˜æ–‡æ¡£
#
# æœ¬æ–‡æ¡£è§£é‡ŠDockeræ„å»ºè¿‡ç¨‹ä¸­çš„å„é¡¹ä¼˜åŒ–ç­–ç•¥å’Œæ–‡ä»¶æ’é™¤é€»è¾‘
# ============================================================================

## ğŸ“‹ ç›®å½•
1. [æ„å»ºä½“ç§¯ä¼˜åŒ–](#æ„å»ºä½“ç§¯ä¼˜åŒ–)
2[.dockerignoreæ–‡ä»¶è¯¦è§£](#dockerignoreæ–‡ä»¶è¯¦è§£)
3. [å¤šé˜¶æ®µæ„å»ºç­–ç•¥](#å¤šé˜¶æ®µæ„å»ºç­–ç•¥)
4. [ç¼“å­˜ä¼˜åŒ–](#ç¼“å­˜ä¼˜åŒ–)
5. [å®é™…æ•°æ®å¯¹æ¯”](#å®é™…æ•°æ®å¯¹æ¯”)
6. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## æ„å»ºä½“ç§¯ä¼˜åŒ–

### å½“å‰ä¼˜åŒ–æªæ–½

| ä¼˜åŒ–æªæ–½ | æ•ˆæœ | è¯´æ˜ |
|---------|------|------|
| å¤šé˜¶æ®µæ„å»º | 70-80% å‡å°‘ | dependencies â†’ builder â†’ production\|development |
| .dockerignore | 15-20% å‡å°‘ | æ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶å’Œç›®å½• |
| npm ci | 5-10% å‡å°‘ | ç›¸æ¯”npm installæ›´å° |
| alpineåŸºç¡€é•œåƒ | 90% å‡å°‘ | ç›¸æ¯”ubuntu/debian |
| node_modulesæ¸…ç† | 5-10% å‡å°‘ | npm cache clean --force |

### ä½“ç§¯é¢„æœŸå€¼

```
Node.js 18 AlpineåŸºç¡€é•œåƒ: ~170MB
+ npm dependencies (prod only): ~80-100MB
+ æ„å»ºäº§ç‰© (dist): ~10-20MB
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç”Ÿäº§é•œåƒæ€»å¤§å°: 260-290MB

å¯¹æ¯”å‚è€ƒï¼š
- å¦‚æœä½¿ç”¨ubuntu:22.04: ~500MB+
- å¦‚æœä¸ä½¿ç”¨å¤šé˜¶æ®µæ„å»º: ~1GB+
- å¦‚æœåŒ…å«devDependencies: ~400MB+
```

---

## .dockerignoreæ–‡ä»¶è¯¦è§£

### ä¸ºä»€ä¹ˆéœ€è¦.dockerignoreï¼Ÿ

1. **å‡å°‘æ„å»ºä¸Šä¸‹æ–‡å¤§å°**ï¼šDockeræ„å»ºæ—¶ä¼šå…ˆæ‰“åŒ…æ‰€æœ‰æ–‡ä»¶åˆ°daemonï¼Œä½“ç§¯è¶Šå°è¶Šå¿«
2. **åŠ å¿«æ„å»ºé€Ÿåº¦**ï¼šä¸éœ€è¦å¤„ç†ä¸ç›¸å…³çš„æ–‡ä»¶
3. **å¢åŠ å®‰å…¨æ€§**ï¼šé˜²æ­¢æ•æ„Ÿæ–‡ä»¶ï¼ˆå¦‚.envã€ç§é’¥ï¼‰è¿›å…¥é•œåƒ
4. **æ”¹å–„ç¼“å­˜æ•ˆç‡**ï¼šä¸å¿…è¦çš„æ–‡ä»¶å˜åŒ–ä¸ä¼šå¯¼è‡´ç¼“å­˜å¤±æ•ˆ

### æ’é™¤è§„åˆ™è¯¦è§£

#### ç‰ˆæœ¬æ§åˆ¶ç›¸å…³ (.git)
```
.git/                   # Gitç‰ˆæœ¬åº“ï¼ˆé€šå¸¸å‡ ç™¾MBï¼‰
```
**ä¸ºä»€ä¹ˆæ’é™¤ï¼Ÿ** æ„å»ºæ—¶ä¸éœ€è¦å®Œæ•´çš„gitå†å²ï¼Œåªéœ€è¦æœ€ç»ˆä»£ç 

#### IDEé…ç½® (.vscode)
```
.vscode/                # VS Codeä¸ªäººé…ç½®
.idea/                  # JetBrains IDEé…ç½®
```
**ä¸ºä»€ä¹ˆæ’é™¤ï¼Ÿ** è¿™äº›æ˜¯æœ¬åœ°å¼€å‘é…ç½®ï¼Œä¸æ˜¯åº”ç”¨ä»£ç çš„ä¸€éƒ¨åˆ†

#### node_modules
```
node_modules/           # npmåŒ…ç›®å½•
```
**ä¸ºä»€ä¹ˆæ’é™¤ï¼Ÿ** 
- Dockerfileä¸­ä¼šé‡æ–°è¿è¡Œ `npm ci` å®‰è£…ä¾èµ–
- æœ¬åœ°çš„node_moduleså¯èƒ½åŒ…å«OSç‰¹å®šçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆä¾‹å¦‚for Linuxçš„åŒ…åœ¨Windowsä¸Šä¸å…¼å®¹ï¼‰
- é‡æ–°å®‰è£…å¯ç¡®ä¿ä¾èµ–ä¸€è‡´æ€§

#### æ„å»ºäº§ç‰© (dist)
```
dist/                   # æ—§çš„Viteæ„å»ºäº§ç‰©
```
**ä¸ºä»€ä¹ˆæ’é™¤ï¼Ÿ** Dockerfileä¸­ä¼šé‡æ–°è¿è¡Œ `npm run build`ï¼Œæ—§äº§ç‰©ä¼šè¢«è¦†ç›–

#### ç¯å¢ƒå˜é‡ (.env*)
```
.env                    # æœ¬åœ°æ•æ„Ÿä¿¡æ¯
.env.local
.env.*.local
```
**ä¸ºä»€ä¹ˆæ’é™¤ï¼Ÿ**
- åŒ…å«APIå¯†é’¥ã€æ•°æ®åº“å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯
- åº”è¯¥ä½¿ç”¨Docker secretsæˆ–è¿è¡Œæ—¶ç¯å¢ƒå˜é‡æ³¨å…¥
- é˜²æ­¢æ„å¤–å°†ç”Ÿäº§å¯†é’¥æäº¤

#### æ•°æ®åº“æ–‡ä»¶ (*.sql)
```
*.sql                   # SQLè¿ç§»è„šæœ¬
migrations/
```
**ä¸ºä»€ä¹ˆæ’é™¤ï¼Ÿ**
- ç”Ÿäº§ç¯å¢ƒåº”ä»è¿œç«¯æ‹‰å–æ•°æ®åº“è¿ç§»
- é•œåƒåº”è¯¥æ— çŠ¶æ€ï¼Œä¸åº”åŒ…å«æ•°æ®åº“æ•°æ®

#### å¼€å‘è„šæœ¬ (*.py, *.ps1)
```
*.py                    # Pythonè„šæœ¬
*.ps1                   # PowerShellè„šæœ¬
```
**ä¸ºä»€ä¹ˆæ’é™¤ï¼Ÿ**
- ä»…ç”¨äºå¼€å‘/éƒ¨ç½²ï¼Œä¸æ˜¯åº”ç”¨è¿è¡Œæ—¶éœ€è¦
- å¦‚æœä¿ç•™ï¼Œå¯èƒ½å¯¼è‡´é•œåƒå¤§å°å¢åŠ æˆ–å¼•å…¥ä¸å¿…è¦çš„ä¾èµ–

#### æ–‡æ¡£ (*.md, *.pdf)
```
README.md
*.md
*.pdf
```
**ä¸ºä»€ä¹ˆæ’é™¤ï¼Ÿ**
- æ–‡æ¡£å¯¹è¿è¡Œæ—¶æ— å¸®åŠ©
- å¯æ˜¾è‘—å‡å°é•œåƒå¤§å°
- å¦‚æœéœ€è¦æ–‡æ¡£ï¼Œåº”ä½¿ç”¨åˆ†ç¦»çš„æ–‡æ¡£é•œåƒæˆ–CDN

---

## å¤šé˜¶æ®µæ„å»ºç­–ç•¥

### å››ä¸ªæ„å»ºé˜¶æ®µçš„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1: dependencies (node:18-alpine)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - ä»…å¤åˆ¶ package*.json                                      â”‚
â”‚ - è¿è¡Œ npm ci (deterministic install)                       â”‚
â”‚ ç›®çš„: æœ€å¤§åŒ–ç¼“å­˜åˆ©ç”¨ï¼Œåªæœ‰package.jsonæ”¹å˜æ‰é‡æ–°å®‰è£…        â”‚
â”‚ äº§å‡º: /app/node_modules (å®Œæ•´çš„npmåŒ…)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ COPY --from=dependencies
                       â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                                 â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ Stage 2: builder               â”‚     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚ - FROM node:18-alpine          â”‚     â”‚
â”‚ - ç»§æ‰¿dependenciesçš„node_...   â”‚     â”‚
â”‚ - å¤åˆ¶å®Œæ•´æºä»£ç                â”‚     â”‚
â”‚ - è¿è¡Œ npm run build           â”‚     â”‚
â”‚ äº§å‡º: /app/dist (é™æ€æ–‡ä»¶)     â”‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                 â”‚                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
    â”‚                      â”‚           â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 3: production â”‚   â”‚    â”‚ Stage 4: development â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - node:18-alpine    â”‚   â”‚    â”‚ - node:18-alpine     â”‚
â”‚ - ä»…PRODä¾èµ–        â”‚   â”‚    â”‚ - å®Œæ•´ä¾èµ–+å·¥å…·      â”‚
â”‚ - ä»…å¤åˆ¶dist        â”‚   â”‚    â”‚ - å¤åˆ¶å…¨éƒ¨æºä»£ç      â”‚
â”‚ - érootç”¨æˆ·        â”‚   â”‚    â”‚ - npm run dev        â”‚
â”‚ å¤§å°: 260-290MB     â”‚   â”‚    â”‚ å¤§å°: 500-600MB      â”‚
â”‚                     â”‚   â”‚    â”‚                      â”‚
â”‚ ç”¨é€”: ç”Ÿäº§éƒ¨ç½²      â”‚   â”‚    â”‚ ç”¨é€”: æœ¬åœ°å¼€å‘       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 COPY â”€â”€â”€â”€â”˜
            --from=builder
```

### ä¸ºä»€ä¹ˆä½¿ç”¨4ä¸ªé˜¶æ®µè€Œä¸æ˜¯3ä¸ªï¼Ÿ

é€šå¸¸Dockerfileå¯ä»¥åªç”¨3ä¸ªé˜¶æ®µ (dependencies â†’ builder â†’ production/development)ï¼Œ
ä½†åˆ†ç¦»dependenciesçš„å¥½å¤„æ˜¯:

1. **æ›´å¥½çš„ç¼“å­˜ç­–ç•¥**
   - dependenciesç¼“å­˜åªä¾èµ–äºpackage.json
   - builderå¯ä»¥ç»§æ‰¿ç¼“å­˜ï¼Œå†å¤åˆ¶æºä»£ç 
   - ä¿®æ”¹æºä»£ç ä¸ä¼šå¯¼è‡´npmé‡æ–°å®‰è£…

2. **ç†è®ºç¼“å­˜å‘½ä¸­ç‡**
   ```
   ç¬¬ä¸€æ¬¡æ„å»º: dependencies (miss) â†’ builder (miss) â†’ stages
   ä¿®æ”¹ä»£ç å: dependencies (hit) âœ“ â†’ builder (miss) â†’ stages
   ä¿®æ”¹package.json: dependencies (miss) â†’ builder (miss) â†’ stages
   ```

3. **æœ€å°åŒ–builderå¤§å°**
   - builder stageä¸´æ—¶ï¼Œä¸ç”¨ä¼˜åŒ–
   - productionå’Œdevelopmentåˆ†ç¦»ä¼˜åŒ–

---

## ç¼“å­˜ä¼˜åŒ–

### Dockeré•œåƒåˆ†å±‚ç¼“å­˜åŸç†

```
DockerfileæŒ‡ä»¤ â”€â†’ Docker Layer â”€â†’ ç¼“å­˜æ£€æŸ¥ â”€â†’ ç¼“å­˜å‘½ä¸­?

COPY package.json ./  â”€â†’ Layer1 â”€â†’ æ£€æŸ¥è¯¥æ–‡ä»¶æ˜¯å¦æ”¹å˜ â”€â†’ æ˜¯å¦ç¼“å­˜
RUN npm ci            â”€â†’ Layer2 â”€â†’ Layer1æœªæ”¹å˜ â”€â†’ ç¼“å­˜å‘½ä¸­!
COPY . .              â”€â†’ Layer3 â”€â†’ æºä»£ç æ”¹å˜ â”€â†’ ç¼“å­˜å¤±æ•ˆ
RUN npm run build     â”€â†’ Layer4 â”€â†’ Layer3æ”¹å˜ â”€â†’ å¿…é¡»é‡æ–°æ‰§è¡Œ
```

### æœ€ä½³å®è·µ

#### âœ… æ­£ç¡®çš„Dockerfileé¡ºåº

```dockerfile
# 1. æœ€ä¸ç»å¸¸å˜åŒ–çš„ä¸œè¥¿æ”¾åœ¨å‰é¢
FROM node:18-alpine
WORKDIR /app

# 2. é™æ€é…ç½®
COPY package*.json ./
RUN npm ci

# 3. æºä»£ç ï¼ˆç»å¸¸å˜åŒ–ï¼‰
COPY . .

# 4. ç¼–è¯‘ï¼ˆå–å†³äºæºä»£ç ï¼‰
RUN npm run build
```

æ­¤é¡ºåºä¸‹ï¼š
- ä¿®æ”¹æºä»£ç  â†’ åªé‡æ–°æ‰§è¡ŒCOPYå’ŒRUN buildï¼ˆå¿«ï¼ï¼‰
- ä¿®æ”¹package.json â†’ é‡æ–°npm ciå’Œbuildï¼ˆç¨æ…¢ï¼‰
- ä¿®æ”¹FROMé•œåƒ â†’ å…¨éƒ¨é‡æ–°æ‰§è¡Œï¼ˆæœ€æ…¢ï¼‰

#### âŒ é”™è¯¯çš„åšæ³•

```dockerfile
# åä¾‹å­1: package.jsonå’Œæºä»£ç æ··åœ¨ä¸€èµ·
COPY . .
RUN npm ci
RUN npm run build
# é—®é¢˜: ä»»ä½•æºæ–‡ä»¶æ”¹å˜éƒ½å¯¼è‡´npm cié‡æ–°æ‰§è¡Œ

# åä¾‹å­2: é¢‘ç¹æ”¹å˜çš„ä¸œè¥¿æ”¾åœ¨å‰é¢
COPY src/ ./src/
COPY package.json ./
RUN npm ci
# é—®é¢˜: srcæ”¹å˜å¯¼è‡´package.json hashæ”¹å˜ï¼Œnpm ciä¸å¾—ä¸é‡æ–°æ‰§è¡Œ
```

### BuildKitç¼“å­˜åŠ é€Ÿ

å¦‚æœä½¿ç”¨Docker BuildKitï¼ˆDocker 18.09+æ¨èï¼‰ï¼Œå¯ä»¥å¯ç”¨é«˜çº§ç¼“å­˜ï¼š

```bash
# å¯ç”¨BuildKit
DOCKER_BUILDKIT=1 docker build -t image:tag .

# åœ¨docker-composeä¸­é…ç½®
docker-compose build --progress=plain zhinengxin-dev
```

BuildKitä¼˜åŠ¿ï¼š
- æ›´æ™ºèƒ½çš„ç¼“å­˜åˆ¤æ–­ï¼ˆä¸æ˜¯ç®€å•çš„æ–‡ä»¶hashï¼‰
- æ”¯æŒç¼“å­˜æŒ‚è½½ï¼ˆé¿å…é‡æ–°ä¸‹è½½npmåŒ…ï¼‰
- æ”¯æŒç§˜å¯†æŒ‚è½½ï¼ˆä¸´æ—¶æ–‡ä»¶ï¼Œä¸è¿›å…¥å±‚ï¼‰

---

## å®é™…æ•°æ®å¯¹æ¯”

### åœºæ™¯: ä¿®æ”¹srcä¸‹çš„ä¸€ä¸ªReactç»„ä»¶æ–‡ä»¶

#### ä¼˜åŒ–å‰ï¼ˆå‡è®¾æ²¡æœ‰.dockerignoreï¼‰
```
COPY . .              (åŒ…å«250MB node_modules, 500MB .git)
â””â”€ è§¦å‘hashæ”¹å˜
RUN npm ci            (é‡æ–°æ‰§è¡Œï¼Œ2-3åˆ†é’Ÿ) âš ï¸
RUN npm run build     (é‡æ–°æ„å»º)

æ„å»ºæ—¶é—´: ~5-7åˆ†é’Ÿ
```

#### ä¼˜åŒ–åï¼ˆå¤šé˜¶æ®µ + .dockerignoreï¼‰
```
dependenciesé˜¶æ®µ: (ç¼“å­˜å‘½ä¸­)
  â””â”€ node_moduleså·²å­˜åœ¨

builderé˜¶æ®µ:
  COPY . .            (ä¸åŒ…å«node_modules, .git)
  â””â”€ ä½“ç§¯å°ï¼Œå¿«é€Ÿhash
RUN npm run build     (ä»…é‡æ–°æ„å»ºï¼Œ1-2åˆ†é’Ÿ)

æ„å»ºæ—¶é—´: ~1-2åˆ†é’Ÿ  âœ“ æé€Ÿ 60-70%
```

### ä½“ç§¯å¯¹æ¯”

```
æ–¹æ¡ˆ                          é•œåƒå¤§å°      å®‰è£…æ—¶é—´
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ— ä¼˜åŒ– (ubuntu + all)         ~1.2GB        10-15åˆ†é’Ÿ
ä»…å¤šé˜¶æ®µæ„å»º                  ~400MB        5-7åˆ†é’Ÿ
å¤šé˜¶æ®µ + .dockerignore        ~280MB        3-5åˆ†é’Ÿ
å¤šé˜¶æ®µ + alpine               ~300MB        2-3åˆ†é’Ÿ
å®Œå…¨ä¼˜åŒ–æ–¹æ¡ˆ âœ“                ~260MB        1-2åˆ†é’Ÿ
```

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜1: æ„å»ºä»ç„¶å¾ˆæ…¢

**ç—‡çŠ¶**: `npm ci` æ¯æ¬¡éƒ½é‡æ–°æ‰§è¡Œï¼Œå³ä½¿æ²¡æ”¹package.json

**åŸå› **: å¯èƒ½åœ¨COPY . .ä¹‹å‰è¿è¡Œäº†ä¼šæ”¹å˜æ–‡ä»¶çš„å‘½ä»¤

**è§£å†³**:
```dockerfile
# âŒ é”™è¯¯
COPY . .
RUN npm ci

# âœ… æ­£ç¡®
COPY package*.json ./
RUN npm ci
COPY . .
```

### é—®é¢˜2: é•œåƒä»ç„¶å¾ˆå¤§ï¼ˆ>500MBï¼‰

**ç—‡çŠ¶**: æ„å»ºå‡ºçš„é•œåƒè¶…è¿‡é¢„æœŸ

**æ£€æŸ¥**:
```bash
# æŸ¥çœ‹åˆ†å±‚å¤§å°
docker history zhinengxin-ai:latest

# æŸ¥çœ‹é•œåƒå†…å®¹å¤§å°
docker run --rm zhinengxin-ai:latest du -sh /*
```

**å¸¸è§åŸå› å’Œè§£å†³**:

1. node_modulesè¿‡å¤§
   ```bash
   # æŸ¥çœ‹åŒ…å¤§å°
   docker run --rm zhinengxin-ai:latest npm ls --depth=0 --all
   
   # ä¼˜åŒ–ï¼šåˆ é™¤ä¸å¿…è¦çš„devDependencies
   npm prune --production
   ```

2. ç¼“å­˜æœªç”Ÿæ•ˆ
   ```bash
   # é‡æ–°æ„å»ºï¼Œè·³è¿‡ç¼“å­˜
   DOCKER_BUILDKIT=1 docker build --no-cache -t image:tag .
   ```

3. æ„å»ºäº§ç‰©è¿‡å¤§
   ```bash
   # æŸ¥çœ‹distå¤§å°
   docker run --rm zhinengxin-ai:latest du -sh dist/
   
   # å¯èƒ½éœ€è¦ä¼˜åŒ–Viteé…ç½®ä¸­çš„ä»£ç åˆ†å‰²
   ```

### é—®é¢˜3: æ„å»ºå¤±è´¥ï¼Œä½†æœ¬åœ°èƒ½è¿è¡Œ

**ç—‡çŠ¶**: `npm ci` æˆ– `npm run build` åœ¨Dockerä¸­å¤±è´¥

**å¸¸è§åŸå› **:
- æœ¬åœ°node_modulesåŒ…å«äº†OSç‰¹å®šçš„äºŒè¿›åˆ¶æ–‡ä»¶
- package-lock.jsonå’Œpackage.jsonç‰ˆæœ¬ä¸åŒ¹é…
- Dockerfileä¸­ä½¿ç”¨äº†ç›¸å¯¹è·¯å¾„

**è§£å†³**:
```dockerfile
# å§‹ç»ˆä½¿ç”¨npm ci (ä¸æ˜¯npm install)
RUN npm ci --production=false

# ä½¿ç”¨ç»å¯¹è·¯å¾„
WORKDIR /app
COPY . .
RUN npm ci
```

---

## ğŸ“Š ç›‘æ§å’Œä¼˜åŒ–å»ºè®®

### å®šæœŸæ£€æŸ¥

```bash
# æ¯å‘¨æ£€æŸ¥é•œåƒå¤§å°
docker images | grep zhinengxin

# è¯†åˆ«æœ€å¤§çš„å±‚
docker history zhinengxin-ai:latest --human --no-trunc | head -20

# æ¯”è¾ƒprodå’Œdevé•œåƒ
docker images | grep zhinengxin | awk '{print $1":"$2, $5}'
```

### æŒç»­ä¼˜åŒ–æ¸…å•

- [ ] package.jsonä¸­æ— ä¸å¿…è¦çš„ä¾èµ–
- [ ] devDependencieså’Œproductionä¾èµ–åˆ†å¼€
- [ ] npm audit æ— ä¸¥é‡æ¼æ´
- [ ] ç”Ÿäº§é•œåƒä¸åŒ…å«æºä»£ç ã€æ–‡æ¡£ã€æµ‹è¯•
- [ ] .dockerignoreåŒ…å«æ‰€æœ‰ä¸å¿…è¦çš„æ–‡ä»¶
- [ ] Dockerfileä¸­COPYé¡ºåºæœ€ä¼˜
- [ ] å®šæœŸæ›´æ–°åŸºç¡€é•œåƒï¼ˆnode:18-alpineæ–°ç‰ˆæœ¬ï¼‰

---

## ğŸ¯ æ€»ç»“

| æ¦‚å¿µ | è¯´æ˜ | æ”¶ç›Š |
|------|------|------|
| **å¤šé˜¶æ®µæ„å»º** | dependencies â†’ builder â†’ prod/dev | 70-80% ä½“ç§¯å‡å°‘ |
| **.dockerignore** | æ’é™¤ä¸å¿…è¦æ–‡ä»¶ | 15-20% ä½“ç§¯å’Œæ—¶é—´å‡å°‘ |
| **ç¼“å­˜ä¼˜åŒ–** | æŒ‡ä»¤æ’åºï¼Œåˆ†ç¦»å˜åŒ–é¢‘ç‡ | 60-70% é‡å»ºæ—¶é—´å‡å°‘ |
| **érootç”¨æˆ·** | å®‰å…¨éš”ç¦» | æé«˜å®‰å…¨æ€§ |
| **å¥åº·æ£€æŸ¥** | è‡ªåŠ¨é‡å¯å¤±è´¥å®¹å™¨ | æé«˜å¯é æ€§ |

æ‰€æœ‰è¿™äº›ä¼˜åŒ–åŠ åœ¨ä¸€èµ·ï¼Œå¯ä»¥å®ç°ï¼š
- âœ… é•œåƒä½“ç§¯: 260-290MB (vs 1GB+)
- âœ… æ„å»ºæ—¶é—´: 1-2åˆ†é’Ÿ (vs 5-10åˆ†é’Ÿ)
- âœ… å®‰å…¨æ€§: érootã€æ— æ•æ„Ÿä¿¡æ¯
- âœ… ç¼“å­˜æ•ˆç‡: ä»£ç æ”¹åŠ¨ååªéœ€1-2åˆ†é’Ÿé‡å»º

