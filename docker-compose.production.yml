# ============================================================================
# Docker Compose - å·¥ä¸šçº§æ ‡å‡†é…ç½®
# æ™ºèƒ½é‘«AI å®Œæ•´æ ˆï¼ˆå‰ç«¯ + åç«¯ + æ•°æ®åº“ï¼‰
#
# âœ… æ·±åº¦ä¼˜åŒ–åŸåˆ™ï¼š
#   1. æ˜¾å¼ç½‘ç»œéš”ç¦» - ä¸“å±è™šæ‹Ÿç½‘ç»œï¼ŒæœåŠ¡é—´åŸŸåé€šè¯
#   2. åŒ¿åå·ä¿æŠ¤ - é˜²æ­¢æœ¬åœ°ç©ºç›®å½•è¦†ç›–å®¹å™¨ä¾èµ–
#   3. æ•°æ®åº“æŒä¹…åŒ– - æ•°æ®å®‰å…¨ï¼Œé‡å¯ä¸ä¸¢å¤±
#   4. .env æ•æ„Ÿä¿¡æ¯ - é›¶æ˜æ–‡å¯†ç 
#
# ä½¿ç”¨æ–¹å¼ï¼š
#   docker-compose -f docker-compose.production.yml --env-file .env up -d
#
# ============================================================================

version: '3.9'

# ============================================================================
# ä¸“å±è™šæ‹Ÿç½‘ç»œ - å†…éƒ¨é€šè¯é€šé“
# ============================================================================
networks:
  # ã€å…³é”®ã€‘æ˜¾å¼åˆ›å»ºä¸“å±ç½‘ç»œï¼Œä¸ä½¿ç”¨é»˜è®¤ç½‘æ¡¥
  # æœåŠ¡é—´å¯ç›´æ¥é€šè¿‡æœåŠ¡åï¼ˆzhinengxin-frontendã€zhinengxin-backend ç­‰ï¼‰è®¿é—®
  zhinengxin-internal:
    driver: bridge
    # è‡ªå®šä¹‰IPAMï¼ˆIPåœ°å€ç®¡ç†ï¼‰é…ç½®
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1

  # å¯é€‰ï¼šä¸ºæ•°æ®åº“å•ç‹¬åˆ›å»ºéšç§ç½‘ç»œï¼ˆå¢å¼ºå®‰å…¨æ€§ï¼‰
  # ç”Ÿäº§ç¯å¢ƒå¯åªè®©åç«¯è®¿é—®æ•°æ®åº“
  zhinengxin-database-private:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
          gateway: 172.21.0.1

# ============================================================================
# å‘½åå· - æ•°æ®æŒä¹…åŒ–å­˜å‚¨
# ============================================================================
volumes:
  # ã€æ•°æ®å®‰å…¨ã€‘æ•°æ®åº“æ•°æ®å·
  # PostgreSQLæ•°æ®æŒä¹…åŒ–ï¼Œç¡®ä¿é‡å¯ä¸ä¸¢å¤±
  zhinengxin-postgres-data:
    driver: local
    driver_opts:
      # å¯é€‰ï¼šæŒ‡å®šæœ¬åœ°å­˜å‚¨è·¯å¾„
      # type: none
      # o: bind
      # device: /data/postgres

  # ã€å¼€å‘ä¾¿åˆ©ã€‘åç«¯node_moduleså·
  # é˜²æ­¢å®¿ä¸»æœºç©ºç›®å½•è¦†ç›–ï¼ŒåŒæ—¶æå‡æ€§èƒ½
  zhinengxin-backend-node-modules:
    driver: local

  # ã€å¼€å‘ä¾¿åˆ©ã€‘å‰ç«¯node_moduleså·
  zhinengxin-frontend-node-modules:
    driver: local

  # ã€å¯é€‰ã€‘åº”ç”¨æ—¥å¿—æŒä¹…åŒ–
  zhinengxin-logs:
    driver: local

# ============================================================================
# æœåŠ¡å®šä¹‰
# ============================================================================
services:

  # ========================================================================
  # ã€1ã€‘æ•°æ®åº“ - PostgreSQL
  # ========================================================================
  zhinengxin-database:
    # ä½¿ç”¨å®˜æ–¹PostgreSQLé•œåƒï¼ˆæ¨è15æˆ–æ›´æ–°ç‰ˆæœ¬ï¼‰
    image: postgres:15-alpine
    container_name: zhinengxin-database

    # ã€å…³é”®ã€‘ä»…åŠ å…¥æ•°æ®åº“ä¸“å±éšç§ç½‘ç»œ
    networks:
      - zhinengxin-database-private
      # åŒæ—¶ä¹ŸåŠ å…¥å†…éƒ¨ç½‘ç»œä¾›åç«¯è®¿é—®
      - zhinengxin-internal

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ç¯å¢ƒå˜é‡ - ä».envæ–‡ä»¶å¼•ç”¨ï¼ˆé›¶æ˜æ–‡å¯†ç ï¼‰
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    environment:
      # ä¸»å¯†ç  - é€šè¿‡.envä¼ å…¥ï¼Œä¸åœ¨æ­¤å¤„æš´éœ²
      POSTGRES_PASSWORD: "${DB_PASSWORD}"
      # ç”¨æˆ·å
      POSTGRES_USER: "${DB_USER:-zhinengxin}"
      # æ•°æ®åº“åç§°
      POSTGRES_DB: "${DB_NAME:-zhinengxin_ai}"
      # PostgreSQLåˆå§‹åŒ–å‚æ•°
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # æ•°æ®æŒä¹…åŒ–
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    volumes:
      # ã€å…³é”®ã€‘æ•°æ®å·æŒ‚è½½ - ç¡®ä¿æ•°æ®æŒä¹…åŒ–
      - zhinengxin-postgres-data:/var/lib/postgresql/data
      # åˆå§‹åŒ–SQLè„šæœ¬ï¼ˆå¯é€‰ï¼‰
      - ./migrations/init.sql:/docker-entrypoint-initdb.d/init.sql

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ç«¯å£é…ç½®ï¼ˆä»…å†…éƒ¨ï¼Œä¸æš´éœ²å¤–ç½‘ï¼‰
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ports:
      # ä»…å†…éƒ¨ä½¿ç”¨ï¼Œä¸æ˜ å°„åˆ°å®¿ä¸»æœº
      - "127.0.0.1:5432:5432"

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # èµ„æºé™åˆ¶
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # å¥åº·æ£€æŸ¥
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-zhinengxin}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # é‡å¯ç­–ç•¥
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    restart: unless-stopped

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # æ—¥å¿—é…ç½®
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ========================================================================
  # ã€2ã€‘åç«¯ API æœåŠ¡ - Node.js
  # ========================================================================
  zhinengxin-backend:
    # ä½¿ç”¨åŒä¸€ä¸ªDockerfileï¼Œä½†targetä¸ºbackend
    # ï¼ˆå‡è®¾ä½ æœ‰ä¸€ä¸ªå¤šé˜¶æ®µDockerfileï¼‰
    build:
      context: .
      dockerfile: Dockerfile
      target: backend
    
    image: zhinengxin-ai:backend
    container_name: zhinengxin-backend

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ã€å…³é”®ã€‘ç½‘ç»œé…ç½®
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    networks:
      - zhinengxin-internal         # å†…éƒ¨é€šä¿¡
      - zhinengxin-database-private # è®¿é—®æ•°æ®åº“

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ç¯å¢ƒå˜é‡ - ä».envå¼•ç”¨
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    environment:
      # è¿è¡Œç¯å¢ƒ
      NODE_ENV: ${NODE_ENV:-production}
      # æ—¥å¿—çº§åˆ«
      LOG_LEVEL: ${LOG_LEVEL:-info}
      
      # â”â”â”â”â”â” æ•°æ®åº“è¿æ¥ â”â”â”â”â”â”
      # ã€é‡è¦ã€‘ä½¿ç”¨æœåŠ¡åä½œä¸ºhostnameï¼ˆDocker Compose DNSï¼‰
      DB_HOST: zhinengxin-database
      DB_PORT: 5432
      DB_USER: "${DB_USER:-zhinengxin}"
      DB_PASSWORD: "${DB_PASSWORD}"
      DB_NAME: "${DB_NAME:-zhinengxin_ai}"
      
      # â”â”â”â”â”â” åº”ç”¨é…ç½® â”â”â”â”â”â”
      API_PORT: 3000
      API_HOST: 0.0.0.0
      
      # â”â”â”â”â”â” æ•æ„Ÿä¿¡æ¯ï¼ˆä».envå¼•ç”¨ï¼‰ â”â”â”â”â”â”
      JWT_SECRET: "${JWT_SECRET}"
      JWT_EXPIRY: "${JWT_EXPIRY:-7d}"
      
      # â”â”â”â”â”â” Redisé…ç½®ï¼ˆå¯é€‰ï¼‰ â”â”â”â”â”â”
      REDIS_URL: "${REDIS_URL:-redis://redis-cache:6379}"
      
      # â”â”â”â”â”â” ç¬¬ä¸‰æ–¹APIé…ç½® â”â”â”â”â”â”
      JOINQUANT_API_KEY: "${JOINQUANT_API_KEY}"
      JOINQUANT_API_SECRET: "${JOINQUANT_API_SECRET}"

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ã€å…³é”®ã€‘å·æŒ‚è½½ - åŒ¿åå·ä¿æŠ¤ä¾èµ–
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    volumes:
      # æŒ‚è½½æºä»£ç ï¼ˆç”¨äºå¼€å‘/è°ƒè¯•ï¼‰
      - ./backend:/app
      
      # ã€æ ¸å¿ƒã€‘åŒ¿åå·ä¿æŠ¤ï¼šé˜²æ­¢æœ¬åœ°ç©ºç›®å½•è¦†ç›–å®¹å™¨å†…çš„node_modules
      # ç»“æœï¼šæœ¬åœ° ./backend ä¼šæŒ‚è½½ï¼Œä½†å…¶å†…çš„ node_modules ä¸ä¼šè¦†ç›–å®¹å™¨çš„
      - zhinengxin-backend-node-modules:/app/node_modules
      
      # ä¿æŠ¤å…¶ä»–é‡è¦ç›®å½•
      - /app/.env.local  # æœ¬åœ°ç¯å¢ƒæ–‡ä»¶ï¼ˆä»…å®¹å™¨å†…ï¼‰
      - /app/dist        # ç¼–è¯‘è¾“å‡ºï¼ˆä»…å®¹å™¨å†…ï¼‰

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ä¾èµ–å…³ç³» - ç¡®ä¿æ•°æ®åº“å…ˆå¯åŠ¨
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    depends_on:
      zhinengxin-database:
        condition: service_healthy

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ç«¯å£æ˜ å°„
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ports:
      - "${BACKEND_PORT:-3000}:3000"

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # èµ„æºé™åˆ¶
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '1'
          memory: 512M

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # å¥åº·æ£€æŸ¥
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # é‡å¯ç­–ç•¥
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    restart: unless-stopped

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # æ—¥å¿—é…ç½®
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    logging:
      driver: json-file
      options:
        max-size: "20m"
        max-file: "5"

  # ========================================================================
  # ã€3ã€‘å‰ç«¯æœåŠ¡ - Node.js + Vite
  # ========================================================================
  zhinengxin-frontend:
    build:
      context: .
      dockerfile: Dockerfile
      target: frontend
    
    image: zhinengxin-ai:frontend
    container_name: zhinengxin-frontend

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ã€å…³é”®ã€‘ç½‘ç»œé…ç½®
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    networks:
      - zhinengxin-internal  # ç”¨äºä¸åç«¯é€šä¿¡

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ç¯å¢ƒå˜é‡
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      
      # â”â”â”â”â”â” APIé…ç½® â”â”â”â”â”â”
      # ã€é‡è¦ã€‘å‰ç«¯é€šè¿‡æœåŠ¡åè®¿é—®åç«¯
      VITE_API_BASE_URL: http://zhinengxin-backend:3000/api
      
      # â”â”â”â”â”â” å¯é€‰ï¼šç¬¬ä¸‰æ–¹æœåŠ¡ â”â”â”â”â”â”
      VITE_ANALYTICS_ID: ${VITE_ANALYTICS_ID:-}

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ã€å…³é”®ã€‘å·æŒ‚è½½ - åŒ¿åå·ä¿æŠ¤ä¾èµ–
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    volumes:
      # æŒ‚è½½æºä»£ç 
      - ./src:/app/src
      - ./public:/app/public
      
      # ã€æ ¸å¿ƒã€‘åŒ¿åå·ä¿æŠ¤node_modules
      - zhinengxin-frontend-node-modules:/app/node_modules
      
      # æŒ‚è½½é…ç½®æ–‡ä»¶ï¼ˆè¿™äº›é€šå¸¸ä¸ä¼šæ”¹å˜ï¼‰
      - ./vite.config.js:/app/vite.config.js
      - ./tailwind.config.js:/app/tailwind.config.js
      
      # ä¿æŠ¤å®¹å™¨å†…éƒ¨çŠ¶æ€
      - /app/dist

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ä¾èµ–å…³ç³»ï¼ˆç¡®ä¿åç«¯å·²å¯åŠ¨ï¼‰
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    depends_on:
      zhinengxin-backend:
        condition: service_healthy

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ç«¯å£æ˜ å°„
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ports:
      - "${FRONTEND_PORT:-80}:3001"

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # èµ„æºé™åˆ¶
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '1'
          memory: 512M

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # å¥åº·æ£€æŸ¥
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # é‡å¯ç­–ç•¥
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    restart: unless-stopped

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # æ—¥å¿—é…ç½®
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    logging:
      driver: json-file
      options:
        max-size: "20m"
        max-file: "5"

  # ========================================================================
  # ã€4ã€‘ç¼“å­˜æœåŠ¡ - Redisï¼ˆå¯é€‰ä½†æ¨èï¼‰
  # ========================================================================
  zhinengxin-cache:
    image: redis:7-alpine
    container_name: zhinengxin-cache

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ç½‘ç»œé…ç½®
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    networks:
      - zhinengxin-internal

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # å¯åŠ¨å‘½ä»¤ï¼ˆå¯†ç ä¿æŠ¤ï¼‰
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    command: >
      redis-server
      --requirepass "${REDIS_PASSWORD}"
      --appendonly yes
      --appendfsync everysec

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # æ•°æ®æŒä¹…åŒ–
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    volumes:
      - zhinengxin-redis-data:/data

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ç«¯å£æ˜ å°„ï¼ˆä»…å†…éƒ¨ï¼‰
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ports:
      - "127.0.0.1:6379:6379"

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # èµ„æºé™åˆ¶
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # å¥åº·æ£€æŸ¥
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # é‡å¯ç­–ç•¥
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    restart: unless-stopped

# ============================================================================
# å·å®šä¹‰è¡¥å……
# ============================================================================
# æ³¨ï¼šRedisæ•°æ®å·
volumes:
  zhinengxin-redis-data:
    driver: local

# ============================================================================
#
# ğŸ“Œ ã€åŸåˆ™1ã€‘æ˜¾å¼ç½‘ç»œéš”ç¦»
#   âœ… å·²å®ç°ï¼š
#      - zhinengxin-internal: å‰ç«¯ã€åç«¯ã€ç¼“å­˜é€šè¯
#      - zhinengxin-database-private: åç«¯ã€æ•°æ®åº“éšç§é€šé“
#   âœ… æ•ˆæœï¼š
#      - æœåŠ¡é—´å¯ç”¨å†…éƒ¨åŸŸåï¼ˆzhinengxin-backendã€zhinengxin-databaseç­‰ï¼‰
#      - å¤–éƒ¨æ— æ³•ç›´æ¥è®¿é—®å†…éƒ¨æœåŠ¡
#
# ğŸ“Œ ã€åŸåˆ™2ã€‘åŒ¿åå·ä¿æŠ¤ä¾èµ–
#   âœ… å·²å®ç°ï¼š
#      - backend: zhinengxin-backend-node-modules:/app/node_modules
#      - frontend: zhinengxin-frontend-node-modules:/app/node_modules
#   âœ… åŸç†ï¼š
#      1. ./backend æŒ‚è½½åˆ° /appï¼ˆåŒ…å«ä½ çš„æºä»£ç ï¼‰
#      2. /app/node_modules æ˜ å°„åˆ°å‘½åå·ï¼ˆå®¹å™¨å†…å®‰è£…çš„ä¾èµ–ï¼‰
#      3. ç»“æœï¼šæœ¬åœ°ç©ºç›®å½•ä¸ä¼šè¦†ç›–å®¹å™¨å†…çš„ä¾èµ–
#   âœ… ä¸ºä½•å…³é”®ï¼š
#      - npm install åœ¨å®¹å™¨å†…è¿è¡Œï¼Œäº§ç”Ÿçš„ node_modules éœ€è¦ä¿æŠ¤
#      - å¦‚æ— åŒ¿åå·ï¼Œå®¿ä¸»æœºçš„ç©ºç›®å½•ä¼šè¦†ç›–ï¼Œå¯¼è‡´ä¾èµ–ä¸¢å¤±
#
# ğŸ“Œ ã€åŸåˆ™3ã€‘æ•°æ®åº“æŒä¹…åŒ–
#   âœ… å·²å®ç°ï¼š
#      - zhinengxin-postgres-data:/var/lib/postgresql/data
#      - zhinengxin-redis-data:/data
#   âœ… æ•ˆæœï¼š
#      - docker-compose down åé‡æ–° upï¼Œæ•°æ®ä¾ç„¶å­˜åœ¨
#      - ç”Ÿäº§ç¯å¢ƒå…³é”®ä¿è¯
#
# ğŸ“Œ ã€åŸåˆ™4ã€‘æ•æ„Ÿä¿¡æ¯ç®¡ç†
#   âœ… å·²å®ç°ï¼š
#      - æ‰€æœ‰å¯†ç ã€å¯†é’¥é€šè¿‡ ${VAR_NAME} ä» .env å¼•ç”¨
#      - ç¤ºä¾‹ï¼š${DB_PASSWORD:?error: DB_PASSWORD not set}
#      - ç»“æœï¼šdocker-compose.yml ä¸­é›¶æ˜æ–‡å¯†ç 
#   âœ… ä½¿ç”¨æ–¹å¼ï¼š
#      - åˆ›å»º .env æ–‡ä»¶ï¼ˆä¸è¦æäº¤åˆ°gitï¼‰
#      - docker-compose ä¼šè‡ªåŠ¨åŠ è½½ .env
#      - æˆ–æ˜¾å¼æŒ‡å®šï¼šdocker-compose --env-file .env.production up
#
# ============================================================================
# ã€å¦‚ä½•ä½¿ç”¨ã€‘
# ============================================================================
#
# 1ï¸âƒ£  åˆ›å»º .env æ–‡ä»¶ï¼ˆå‚è€ƒä¸‹æ–¹ç¤ºä¾‹ï¼‰
#
# 2ï¸âƒ£  å¯åŠ¨å®Œæ•´æ ˆ
#     docker-compose -f docker-compose.production.yml --env-file .env up -d
#
# 3ï¸âƒ£  æŸ¥çœ‹æ—¥å¿—
#     docker-compose -f docker-compose.production.yml logs -f zhinengxin-backend
#
# 4ï¸âƒ£  è¿›å…¥å®¹å™¨
#     docker exec -it zhinengxin-backend sh
#
# 5ï¸âƒ£  åœæ­¢æœåŠ¡
#     docker-compose -f docker-compose.production.yml down
#
# 6ï¸âƒ£  å®Œå…¨æ¸…ç†ï¼ˆåŒ…æ‹¬å·ï¼‰
#     docker-compose -f docker-compose.production.yml down -v
#
# ============================================================================
# ã€.env æ–‡ä»¶ç¤ºä¾‹ã€‘
# ============================================================================
#
# # â”â”â”â”â”â” æ•°æ®åº“ â”â”â”â”â”â”
# DB_USER=zhinengxin
# DB_PASSWORD=YourSecurePassword123!@#
# DB_NAME=zhinengxin_ai
#
# # â”â”â”â”â”â” åº”ç”¨ â”â”â”â”â”â”
# NODE_ENV=production
# LOG_LEVEL=info
# JWT_SECRET=your-super-secret-jwt-key-keep-it-safe
# JWT_EXPIRY=7d
#
# # â”â”â”â”â”â” Redis â”â”â”â”â”â”
# REDIS_PASSWORD=RedisSecurePassword123!
#
# # â”â”â”â”â”â” ç¬¬ä¸‰æ–¹API â”â”â”â”â”â”
# JOINQUANT_API_KEY=your-joinquant-key
# JOINQUANT_API_SECRET=your-joinquant-secret
#
# # â”â”â”â”â”â” å‰ç«¯é…ç½® â”â”â”â”â”â”
# VITE_ANALYTICS_ID=optional-tracking-id
#
# # â”â”â”â”â”â” ç«¯å£æ˜ å°„ â”â”â”â”â”â”
# BACKEND_PORT=3000
# FRONTEND_PORT=80
#
# ============================================================================
