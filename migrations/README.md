# 智能鑫AI系统数据库迁移

## 简介

本目录包含智能鑫AI系统的数据库迁移脚本，用于管理数据库结构的变更。迁移脚本支持向上迁移(Up)和向下迁移(Down)，可以轻松管理数据库的版本控制。

## 迁移脚本结构

每个迁移脚本包含两部分：

1. **UP REVISION** - 用于创建或修改数据库结构的SQL语句
2. **DOWN REVISION** - 用于回滚数据库结构变更的SQL语句

迁移脚本命名规则：`YYYYMMDD_HHMMSS_description.sql`

- `YYYYMMDD_HHMMSS` - 迁移版本号，基于创建时间
- `description` - 迁移描述

## 已创建的迁移脚本

| 版本号 | 文件名 | 描述 |
|-------|-------|------|
| 20251215_000000 | `20251215_000000_complete_schema.sql` | 创建完整的智能鑫AI系统数据库表结构 |

## 使用方法

### 1. 执行迁移

#### 使用PowerShell脚本（推荐）

```powershell
# 执行所有未应用的向上迁移
.\migrate.ps1

# 执行特定版本的向上迁移
.\migrate.ps1 -Action Up -Version 20251215_000000

# 执行向下迁移
.\migrate.ps1 -Action Down -Version 20251215_000000
```

#### 使用psql命令直接执行

```bash
# 执行向上迁移
psql -U admin -d stockdb -f migrations/20251215_000000_complete_schema.sql

# 执行向下迁移（需要先修改脚本，取消注释Down部分）
# 1. 编辑迁移脚本，取消注释Down部分的SQL代码
# 2. 执行脚本
psql -U admin -d stockdb -f migrations/20251215_000000_complete_schema.sql
```

### 2. 在Docker容器中执行

如果PostgreSQL运行在Docker容器中，可以使用以下命令：

```bash
# 执行向上迁移
docker exec -i postgres-container psql -U admin -d stockdb -f /dev/stdin < migrations/20251215_000000_complete_schema.sql

# 执行向下迁移
docker exec -i postgres-container psql -U admin -d stockdb -f /dev/stdin < migrations/20251215_000000_complete_schema.sql
```

## 迁移工作流程

1. **创建迁移脚本**：根据数据库变更需求，创建新的迁移脚本
2. **执行向上迁移**：将迁移应用到数据库
3. **测试迁移**：验证数据库结构变更是否正确
4. **记录迁移历史**：迁移脚本会自动记录到`migration_history`表中
5. **如需回滚**：执行向下迁移，恢复到之前的数据库状态

## 迁移历史表

迁移历史记录保存在`migration_history`表中，包含以下字段：

- `id` - 记录ID
- `version` - 迁移版本号
- `name` - 迁移名称
- `applied_at` - 应用时间
- `description` - 迁移描述

## 注意事项

1. **迁移顺序**：迁移脚本按照版本号顺序执行
2. **幂等性**：所有迁移脚本都具有幂等性，可以安全重复执行
3. **向下迁移**：向下迁移会删除数据，请谨慎执行
4. **事务处理**：迁移脚本中的每个操作都是独立的，建议在执行前备份数据库
5. **依赖关系**：确保迁移脚本的创建顺序正确，处理好表之间的依赖关系

## 故障排除

### 1. 迁移失败

如果迁移失败，检查以下内容：

- 数据库连接是否正常
- SQL语法是否正确
- 表之间的依赖关系是否正确
- 数据库用户是否有足够的权限

### 2. 向下迁移失败

如果向下迁移失败，检查以下内容：

- 是否已经取消注释迁移脚本中的Down部分
- 表之间的依赖关系是否正确处理
- 是否有外键约束导致删除失败

### 3. 查看迁移日志

迁移日志保存在项目根目录的`migration_log.txt`文件中，可以查看详细的迁移执行过程和错误信息。

## 最佳实践

1. **定期备份数据库**：在执行迁移前，建议备份数据库
2. **先在测试环境中执行**：在生产环境执行前，先在测试环境中验证
3. **使用迁移历史**：定期检查迁移历史，确保所有迁移都已正确应用
4. **命名规范**：遵循统一的迁移脚本命名规范
5. **文档化**：在迁移脚本中添加详细的注释，说明迁移的目的和变更内容

## 联系方式

如有任何问题或建议，请联系智能鑫AI系统开发团队。
